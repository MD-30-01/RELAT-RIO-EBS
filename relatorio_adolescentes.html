<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EBS Relat√≥rio de Frequ√™ncia - CLASSE DOS ADOLESCENTES</title>
    <style>
        /* --- ESTILOS CSS BASE --- */
        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
        .logo-area { text-align: center; padding: 10px; background-color: #e0f7fa; border-bottom: 2px solid #007bff; margin-bottom: 20px; }
        h1 { text-align: center; color: #2F4F4F; margin: 5px 0 10px 0; font-size: 24px; }
        h2 { font-size: 18px; color: #007bff; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 20px; text-align: center; }
        .info-cabecalho { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; }
        .campo-info { display: flex; align-items: center; }
        .campo-info label { font-weight: bold; margin-right: 5px; white-space: nowrap; }
        /* Removido input[type="text"] para n√£o afetar type="date" e type="time" */
        .info-cabecalho input[type="text"], 
        .info-cabecalho input[type="date"], 
        .info-cabecalho input[type="time"] { padding: 5px; border: 1px solid #ccc; width: 120px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 13px; }
        th { background-color: #f2f2f2; color: #333; font-weight: bold; }
        .aluno-nome { text-align: left; width: 30%; }
        .aluno-nome input[type="text"] { width: 100%; border: none; padding: 0; margin: 0; box-sizing: border-box; }
        input[type="number"] { width: 30px; text-align: center; }
        .btn-acao { padding: 10px 15px; border: none; cursor: pointer; border-radius: 5px; margin: 5px; color: white; font-weight: bold; }
        #btn-adicionar { background-color: #4CAF50; }
        #btn-salvar { background-color: #007bff; }
        #btn-reset { background-color: #9E9E9E; }
        .botoes-acao { text-align: center; margin-top: 10px; }
        .btn-remover { padding: 3px 8px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .coluna-acoes { width: 40px; }
        .coluna-pontos { font-weight: bold; color: #1e8449; } /* Cor para pontua√ß√£o na tabela */
        .tabela-totais { margin-top: 30px; padding: 15px; border: 1px solid #007bff; background-color: #f9fcff; display: flex; flex-wrap: wrap; justify-content: space-around; font-size: 14px; }
        .tabela-totais h2 { width: 100%; margin: 0 0 10px 0; text-align: left; border: none; }
        .total-linha { font-weight: bold; padding: 5px 15px; border-right: 1px solid #ccc; }
        .total-linha:last-child { border-right: none; }
        .total-linha span { color: #d32f2f; margin-left: 5px; }

        /* --- Estilo para o bot√£o de voltar --- */
        .area-voltar { text-align: center; margin-bottom: 15px; }
        #btn-voltar { background-color: #6c757d; padding: 8px 15px; text-decoration: none; border-radius: 5px; color: white; font-weight: bold; display: inline-block; }


        /* --- ESTILOS DO RANKING GERAL (TRIMESTRE) --- */
        .ranking-trimestral-container {
            margin-top: 40px;
            padding: 20px;
            background-color: #ffd70030; /* Fundo mais claro */
            border: 2px solid #FFD700; /* Borda dourada */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .ranking-trimestral-container h2 {
            color: #daa520; /* Dourado escuro */
            border-bottom: 2px solid #FFD700;
        }
        .trimestre-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: #ffffff;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            border-left: 5px solid #FFD700;
        }
        .trimestre-item .posicao {
            font-size: 28px;
            margin-right: 15px;
            font-weight: 900;
        }
        .trimestre-item .nome {
            flex-grow: 1;
            font-weight: bold;
            color: #333;
            text-align: left;
        }
        .trimestre-item .pontos {
            font-size: 20px;
            font-weight: 900;
            color: #b8860b; /* Dourado */
        }
        
        /* Estilos de outras se√ß√µes mantidos */
        .dashboard-container { margin-top: 40px; padding: 20px; background-color: #e0f7fa; border: 2px solid #00bcd4; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .desempenho-individual-container { margin-top: 40px; padding: 20px; background-color: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .desempenho-individual-container h2 { color: #d35400; border-bottom: 2px solid #ff9800; }
        .aluno-desempenho-card { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dashed #f57c00; }
        .aluno-desempenho-card .nome { font-weight: bold; width: 30%; text-align: left; color: #555; }
        .aluno-desempenho-card .status { width: 14%; font-size: 16px; text-align: center; }
        .aluno-desempenho-card .pontos-totais { width: 10%; font-weight: bold; color: #1e8449; text-align: center; }
        .status-ok { color: #4CAF50; } 
        .status-fail { color: #f44336; } 

        /* --- NOVO: Estilos para os Bot√µes de Ordena√ß√£o --- */
        .coluna-ordem { width: 60px; }
        .btn-mover { 
            padding: 2px 5px; 
            border: none; 
            cursor: pointer; 
            border-radius: 3px;
            font-size: 14px;
            line-height: 1;
            margin: 0 1px;
            color: white; /* Para destacar a seta */
        }
        .btn-subir { background-color: #2196F3; } /* Azul */
        .btn-descer { background-color: #ff9800; } /* Laranja */

    </style>
</head>
<body>

    <div class="logo-area">
        <img src="logo.png.webp" alt="Logo ADOCI Jardim Mar√≠lia" style="max-height: 150px; margin-bottom: 10px;"> 
        <div style="font-size: 28px; font-weight: bold; color: #000080;">ADOCI JARDIM MAR√çLIA</div>
        <div style="font-size: 18px; color: #808080;">EBS - RELAT√ìRIO DE FREQU√äNCIA</div>
        <div style="font-size: 20px; color: #1e8bd4;">CLASSE DOS ADOLESCENTES</div>
    </div>
    
    <div class="area-voltar">
        <a href="index.html" id="btn-voltar">üè†</a>
    </div>

    <div class="info-cabecalho">
        <div class="campo-info"><label for="data-relatorio">DATA:</label><input type="date" id="data-relatorio"></div>
        <div class="campo-info"><label for="hora-relatorio">HORA:</label><input type="time" id="hora-relatorio"></div>
        <div class="campo-info"><label for="professor">PROFESSOR(A):</label><input type="text" id="professor" placeholder="Nome do Professor"></div>
        <div class="campo-info"><label for="licao-relatorio">LI√á√ÉO:</label><input type="text" id="licao-relatorio" placeholder="N¬∫ da Li√ß√£o"></div>
        <div class="campo-info"><label for="tema-relatorio">TEMA:</label><input type="text" id="tema-relatorio" placeholder="Tema da Aula"></div>
    </div>
    
    <div class="botoes-acao">
        <button id="btn-adicionar" class="btn-acao" onclick="adicionarAluno()">‚ûï Adicionar Aluno</button>
        <button id="btn-salvar" class="btn-acao" onclick="salvarRelatorio()">üíæ Salvar Relat√≥rio e Dados da Aula</button>
        <button id="btn-reset" class="btn-acao" onclick="resetarDados()">üóëÔ∏è Resetar Dados Trimestrais</button>
    </div>

    <h2>LISTA DE FREQU√äNCIA (Aula Atual)</h2>
    <table>
        <thead>
            <tr>
                <th>N¬∫</th>
                <th class="aluno-nome">NOME</th>
                <th>PRESEN√áA</th>
                <th>AUSENTES</th>
                <th>VISITANTES</th>
                <th>REVISTA</th>
                <th>B√çBLIA</th>
                <th>OFERTAS</th>
                <th>PONTOS</th>
                <th class="coluna-acoes">A√ß√µes</th>
                <th class="coluna-ordem">ORDEM</th> 
            </tr>
        </thead>
        <tbody id="corpo-tabela-alunos">
            </tbody>
    </table>

    <div class="tabela-totais">
        <h2>TOTAIS GERAIS</h2>
        <div class="total-linha"> AULAS SALVAS: <span id="total_aulas_salvas">0</span> </div>
        <div class="total-linha"> MATRICULADOS: <span id="total_matriculados">0</span> </div>
        <div class="total-linha"> PRESENTES: <span id="total_presentes">0</span> </div>
        <div class="total-linha"> AUSENTES: <span id="total_ausentes">0</span> </div>
        <div class="total-linha"> VISITANTES: <span id="total_visitantes">0</span> </div>
        <div class="total-linha"> REVISTAS: <span id="total_revista">0</span> </div>
        <div class="total-linha"> B√çBLIAS: <span id="total_biblia">0</span> </div>
        <div class="total-linha"> OFERTAS: <span id="total_oferta">0</span> </div>
    </div>

    <div class="ranking-trimestral-container">
        <h2>üèÜ RANKING GERAL DO TRIMESTRE</h2>
        <div id="container-ranking-trimestral">
            </div>
    </div>

    <div class="dashboard-container">
        <h2>üìä DASHBOARD DE PERFORMANCE DA AULA (GERAL)</h2>
        <div id="dashboard-conteudo">
            </div>
    </div>

   <div class="desempenho-individual-container">
        <h2>üßë‚Äçüéì AN√ÅLISE DE DESEMPENHO INDIVIDUAL (Aula Atual)</h2>
        <div style="display: flex; font-weight: bold; border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">
            <div style="width: 30%; text-align: left;">ALUNOS</div>
            <div style="width: 14%; text-align: center;">PRESEN√áAS</div>
            <div style="width: 14%; text-align: center;">B√çBLIAS</div>
            <div style="width: 14%; text-align: center;">REVISTAS</div>
            <div style="width: 14%; text-align: center;">OFERTAS</div>
            <div style="width: 10%; text-align: center;">PONTOS</div>
        </div>
        <div id="container-desempenho-alunos">
            </div>
    </div>

    <script>
        const TURMA = "ADOLESCENTES";
        const KEY_ALUNOS = `${TURMA}_matriculados`;
        const KEY_RELATORIOS = `${TURMA}_relatorios_trimestre`;
        const PONTOS_REGRAS = { presenca: 1, biblia: 1, revista: 2, oferta: 2, visitantes: 3 };

        // --- FUN√á√ïES DE PERSIST√äNCIA (localStorage) ---

        function getAlunosMatriculados() {
            const alunosJson = localStorage.getItem(KEY_ALUNOS);
            return alunosJson ? JSON.parse(alunosJson) : []; 
        }

        function setAlunosMatriculados(alunos) {
            localStorage.setItem(KEY_ALUNOS, JSON.stringify(alunos));
        }

        function getRelatoriosTrimestre() {
            const relatoriosJson = localStorage.getItem(KEY_RELATORIOS);
            return relatoriosJson ? JSON.parse(relatoriosJson) : [];
        }

        function addRelatorioTrimestre(relatorio) {
            const relatorios = getRelatoriosTrimestre();
            relatorios.push(relatorio);
            localStorage.setItem(KEY_RELATORIOS, JSON.stringify(relatorios));
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO E C√ÅLCULO ---

        function calcularPontuacao(presente, biblia, revista, oferta, visitantes) {
            let pontuacaoTotal = 0;
            if (presente) {
                pontuacaoTotal += PONTOS_REGRAS.presenca;
                // Pontos de Materiais (s√≥ se estiver presente)
                if (biblia) { pontuacaoTotal += PONTOS_REGRAS.biblia; }
                if (revista) { pontuacaoTotal += PONTOS_REGRAS.revista; }
                if (oferta) { pontuacaoTotal += PONTOS_REGRAS.oferta; }
            }
            // Pontos de Visitantes (sempre contam)
            pontuacaoTotal += visitantes * PONTOS_REGRAS.visitantes;
            return pontuacaoTotal;
        }

        function calcularTotais() {
            const corpoTabela = document.getElementById('corpo-tabela-alunos');
            const linhasAlunos = corpoTabela.querySelectorAll('.linha-aluno');
            
            let totalPresenca = 0, totalBiblia = 0, totalVisitantes = 0, totalRevista = 0, totalOferta = 0;
            const dadosAlunosSessao = []; 

            linhasAlunos.forEach((linha, index) => {
                linha.querySelector('.num-aluno').textContent = (index + 1).toString().padStart(2, '0');

                // Adiciona o data-old-name se n√£o existir (para alunos carregados)
                const nomeInput = linha.querySelector('.nome-aluno');
                if (!nomeInput.getAttribute('data-old-name')) {
                     nomeInput.setAttribute('data-old-name', nomeInput.value);
                }

                const nome = nomeInput.value;
                const presente = linha.querySelector('.presenca').checked;
                const biblia = linha.querySelector('.biblia').checked;
                const revista = linha.querySelector('.revista').checked;
                const oferta = linha.querySelector('.oferta').checked;
                const visitantes = parseInt(linha.querySelector('.visitantes').value) || 0;

                const pontuacaoTotal = calcularPontuacao(presente, biblia, revista, oferta, visitantes);

                // Atualizar PONTOS na tabela principal
                linha.querySelector('.pontos-aluno').textContent = pontuacaoTotal;
                
                // Armazenar dados para Ranking e An√°lise
                dadosAlunosSessao.push({
                    nome: nome,
                    pontuacao: pontuacaoTotal,
                    presente: presente,
                    biblia: biblia,
                    revista: revista,
                    oferta: oferta,
                    visitantes: visitantes 
                });

                // Atualizar TOTAIS GERAIS
                if (presente) { totalPresenca++; }
                // Contagem de materiais e oferta s√≥ conta se estiver presente
                if (presente && biblia) { totalBiblia++; }
                if (presente && revista) { totalRevista++; }
                if (presente && oferta) { totalOferta++; }
                totalVisitantes += visitantes;
            });

            const totalMatriculados = linhasAlunos.length;
            const totalAulasSalvas = getRelatoriosTrimestre().length;

            // 2. Atualizar os TOTAIS
            document.getElementById('total_aulas_salvas').textContent = totalAulasSalvas;
            document.getElementById('total_matriculados').textContent = totalMatriculados;
            document.getElementById('total_visitantes').textContent = totalVisitantes;
            document.getElementById('total_revista').textContent = totalRevista;
            document.getElementById('total_biblia').textContent = totalBiblia;
            document.getElementById('total_oferta').textContent = totalOferta;
            
            // 3. Atualizar Dashboard e Desempenho Individual
            atualizarDashboard(totalMatriculados, totalPresenca, totalBiblia, totalRevista);
            analisarDesempenhoIndividual(dadosAlunosSessao);
            
            // 4. Calcular Ranking Trimestral
            calcularRankingTrimestral();


            return { totalPresenca, totalVisitantes, totalRevista, totalBiblia, totalOferta, dadosAlunosSessao };
        }
        
        function atualizarDashboard(totalMatriculados, totalPresenca, totalBiblia, totalRevista) {
            const dashboardContainer = document.getElementById('dashboard-conteudo');
            const presencaPercentual = totalMatriculados > 0 
                ? ((totalPresenca / totalMatriculados) * 100).toFixed(0) 
                : 0;
            const baseParaMateriais = totalPresenca > 0 ? totalPresenca : 1;
            const bibliaPercentual = ((totalBiblia / baseParaMateriais) * 100).toFixed(0);
            const revistaPercentual = ((totalRevista / baseParaMateriais) * 100).toFixed(0);

            const html = `
                <div class="kpi-card">
                    <span class="label">Taxa de Presen√ßa :</span>
                    <div class="progress-bar-container">
                        <div id="presenca-bar" class="progress-bar" style="width: ${presencaPercentual}%; background-color: ${presencaPercentual < 50 ? '#f44336' : '#4CAF50'};">${presencaPercentual}%</div>
                    </div>
                    <span class="value">${presencaPercentual}%</span>
                </div>
                <div class="kpi-card">
                    <span class="label">Taxa de B√≠blia Trazida (dos Presentes):</span>
                    <div class="progress-bar-container">
                        <div id="biblia-bar" class="progress-bar" style="width: ${bibliaPercentual}%; background-color: #2196F3;">${bibliaPercentual}%</div>
                    </div>
                    <span class="value">${bibliaPercentual}%</span>
                </div>
                <div class="kpi-card">
                    <span class="label">Taxa de Revista Trazida (dos Presentes):</span>
                    <div class="progress-bar-container">
                        <div id="revista-bar" class="progress-bar" style="width: ${revistaPercentual}%; background-color: #FF9800;">${revistaPercentual}%</div>
                    </div>
                    <span class="value">${revistaPercentual}%</span>
                </div>
                <div class="kpi-card">
                    <span class="label">Taxa de Ofertas Trazida (dos Presentes):</span>
                    <div class="progress-bar-container">
                        <div id="revista-bar" class="progress-bar" style="width: ${ofertaPercentual}%; background-color: #FF9800;">${ofertaPercentual}%</div>
                    </div>
                    <span class="value">${ofertaPercentual}%</span>
                </div>
            `;
            dashboardContainer.innerHTML = html;
        }

        function analisarDesempenhoIndividual(dadosAlunos) {
            const container = document.getElementById('container-desempenho-alunos');
            container.innerHTML = ''; 

            const getStatusIcon = (checked) => 
                `<span class="status-icon ${checked ? 'status-ok' : 'status-fail'}">${checked ? '‚úÖ' : '‚ùå'}</span>`;

            dadosAlunos.forEach(aluno => {
                const html = `
                    <div class="aluno-desempenho-card">
                        <div class="nome">${aluno.nome}</div>
                        <div class="status">${getStatusIcon(aluno.presente)}</div>
                        <div class="status">${aluno.presente ? getStatusIcon(aluno.biblia) : getStatusIcon(false)}</div> 
                        <div class="status">${aluno.presente ? getStatusIcon(aluno.revista) : getStatusIcon(false)}</div>
                        <div class="status">${aluno.presente ? getStatusIcon(aluno.oferta) : getStatusIcon(false)}</div>
                        <div class="pontos-totais">${aluno.pontuacao} Pts</div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }
        
        function calcularRankingTrimestral() {
            const relatorios = getRelatoriosTrimestre();
            const rankingTotal = {}; // { 'Nome do Aluno': 150 }
            const rankingContainer = document.getElementById('container-ranking-trimestral');
            rankingContainer.innerHTML = '';

            if (relatorios.length === 0) {
                rankingContainer.innerHTML = '<div style="text-align: center; color: #999;">Nenhum relat√≥rio salvo ainda neste trimestre.</div>';
                return;
            }

            // 1. Somar os pontos de todos os relat√≥rios
            relatorios.forEach(relatorio => {
                relatorio.alunos.forEach(aluno => {
                    if (rankingTotal[aluno.nome]) {
                        rankingTotal[aluno.nome] += aluno.pontuacao;
                    } else {
                        rankingTotal[aluno.nome] = aluno.pontuacao;
                    }
                });
            });

            // 2. Converter para Array para Classifica√ß√£o
            const rankingArray = Object.keys(rankingTotal).map(nome => ({
                nome: nome,
                pontuacao: rankingTotal[nome]
            }));

            // 3. Classificar (Rankear)
            rankingArray.sort((a, b) => b.pontuacao - a.pontuacao);

            // 4. Exibir o Ranking (Top 3)
            rankingArray.slice(0, 3).forEach((aluno, index) => {
                const posicao = index + 1;
                let icone = '';
                if (posicao === 1) icone = 'ü•á';
                else if (posicao === 2) icone = 'ü•à';
                else if (posicao === 3) icone = 'ü•â';

                const html = `
                    <div class="trimestre-item">
                        <span class="posicao">${icone}</span>
                        <span class="nome">${aluno.nome}</span>
                        <span class="pontos">${aluno.pontuacao} Pts (Total)</span>
                    </div>
                `;
                rankingContainer.innerHTML += html;
            });
        }


        // --- FUN√á√ïES DE MANIPULA√á√ÉO DA TABELA (Interface) ---

        function adicionarAluno(nome = '') {
            const corpoTabela = document.getElementById('corpo-tabela-alunos');
            const numeroAlunos = corpoTabela.children.length;
            const novoNome = nome || `Novo Aluno ${numeroAlunos + 1}`;

            const novaLinha = document.createElement('tr');
            novaLinha.classList.add('linha-aluno');
            
            // INCLUS√ÉO DOS BOT√ïES DE ORDENA√á√ÉO NA NOVA C√âLULA (coluna-ordem)
            novaLinha.innerHTML = `
                <td><span class="num-aluno">${(numeroAlunos + 1).toString().padStart(2, '0')}</span></td>
                <td class="aluno-nome"><input type="text" class="nome-aluno" value="${novoNome}" placeholder="Nome do Aluno" oninput="atualizarNomeAluno(this)"></td>
                <td><input type="checkbox" class="presenca" onchange="calcularTotais()"></td>
                <td><input type="checkbox" class="ausentes" onchange="calcularTotais()"></td>
                <td><input type="number" class="visitantes" min="0" value="0" oninput="calcularTotais()"></td>
                <td><input type="checkbox" class="revista" onchange="calcularTotais()"></td>
                <td><input type="checkbox" class="biblia" onchange="calcularTotais()"></td>
                <td><input type="checkbox" class="oferta" onchange="calcularTotais()"></td>
                <td class="coluna-pontos"><span class="pontos-aluno">0</span></td>
                <td class="coluna-acoes"><button class="btn-remover" onclick="removerAluno(this)">X</button></td>
                <td class="coluna-ordem">
                    <button class="btn-mover btn-subir" onclick="moverAluno(this, -1)">‚¨ÜÔ∏è</button>
                    <button class="btn-mover btn-descer" onclick="moverAluno(this, 1)">‚¨áÔ∏è</button>
                </td>
            `;

            corpoTabela.appendChild(novaLinha);
            
            // Se for adi√ß√£o manual (sem nome), atualiza a lista de matriculados
            if (!nome) {
                 const alunos = getAlunosMatriculados();
                 alunos.push(novoNome);
                 setAlunosMatriculados(alunos);
            }
            // Garante que o atributo data-old-name seja definido
            novaLinha.querySelector('.nome-aluno').setAttribute('data-old-name', novoNome);

            calcularTotais();
        }
        
        function removerAluno(botao) {
            const linha = botao.closest('tr');
            const nomeRemovido = linha.querySelector('.nome-aluno').value;

            // 1. Remove da lista de matriculados persistente
            let alunos = getAlunosMatriculados();
            alunos = alunos.filter(n => n !== nomeRemovido);
            setAlunosMatriculados(alunos);
            
            // 2. Remove da tabela e recalcula
            linha.remove();
            calcularTotais();
            reordenarNumeracao();
        }

        function atualizarNomeAluno(input) {
            const nomeAntigo = input.getAttribute('data-old-name');
            const novoNome = input.value;

            if (nomeAntigo && nomeAntigo !== novoNome) {
                let alunos = getAlunosMatriculados();
                // Acha e substitui o nome antigo pelo novo
                const index = alunos.indexOf(nomeAntigo);
                if (index !== -1) {
                    alunos[index] = novoNome;
                    setAlunosMatriculados(alunos);
                }
            }
            // Atualiza o atributo para rastrear futuras mudan√ßas
            input.setAttribute('data-old-name', novoNome);
            calcularTotais(); // Recalcula totais caso a mudan√ßa afete o ranking
        }

        function carregarAlunosIniciais() {
            let alunos = getAlunosMatriculados();
            const corpoTabela = document.getElementById('corpo-tabela-alunos');
            corpoTabela.innerHTML = ''; // Limpa a tabela antes de carregar

            if (alunos.length === 0) {
                 // Se a lista estiver vazia (primeiro acesso/reset), adiciona nomes iniciais
                 alunos = ["Aluno Teste A", "Aluno Teste B", "Aluno Teste C"];
                 setAlunosMatriculados(alunos); 
            }

            alunos.forEach(nome => {
                adicionarAluno(nome);
            });
            calcularTotais();
        }
        
        function resetarDados() {
            if (confirm("ATEN√á√ÉO: Isso apagar√° todos os relat√≥rios salvos e a lista de alunos matriculados para a turma de ADULTOS. Esta a√ß√£o √© irrevers√≠vel e deve ser feita apenas no fim do trimestre. Deseja continuar?")) {
                localStorage.removeItem(KEY_ALUNOS);
                localStorage.removeItem(KEY_RELATORIOS);
                carregarAlunosIniciais(); // Recarrega com nomes iniciais
                reordenarNumeracao();
                alert("Dados trimestrais de ADULTOS resetados com sucesso.");
            }
        }


        function salvarRelatorio() {
            const { dadosAlunosSessao } = calcularTotais();
            
            // Para inputs type="date" e type="time", o valor √© AAAA-MM-DD e HH:MM
            const dataPadrao = document.getElementById('data-relatorio').value;
            if (!dataPadrao) {
                alert("Por favor, preencha a DATA do relat√≥rio antes de salvar.");
                return;
            }

            // Formata√ß√£o da data para o CSV/Alerta (opcional, mas mais amig√°vel)
            const [ano, mes, dia] = dataPadrao.split('-');
            const dataFormatada = `${dia}/${mes}/${ano}`;
            
            // 1. SALVAR NO LOCAL STORAGE (Trimestral) - PRINCIPAL
            const relatorioSessao = {
                data: dataPadrao, // Salva no formato padr√£o para facilitar compara√ß√µes futuras
                alunos: dadosAlunosSessao
            };
            addRelatorioTrimestre(relatorioSessao);

            // 2. GERAR ARQUIVO CSV (C√≥pia de Seguran√ßa)
            const hora = document.getElementById('hora-relatorio').value || 'N/A';
            const professor = document.getElementById('professor').value || 'N/A';
            const turma = document.getElementById('turma').value;
            const licao = document.getElementById('licao-relatorio').value || 'N/A';
            const tema = document.getElementById('tema-relatorio').value || 'N/A';
            const totalMatriculados = document.getElementById('total_matriculados').textContent;
            const totais = calcularTotais();

            let conteudo = `RELAT√ìRIO DE FREQU√äNCIA - ADOCI JARDIM MAR√çLIA - TURMA: ${turma}\n`;
            conteudo += `--------------------------------------------------\n`;
            conteudo += `DATA: ${dataFormatada} | HORA: ${hora} | PROFESSOR: ${professor}\n`;
            conteudo += `LI√á√ÉO: ${licao} | TEMA: ${tema}\n`;
            conteudo += `--------------------------------------------------\n\n`;

            conteudo += `TOTAIS GERAIS (SESS√ÉO):\n`;
            conteudo += `MATRICULADOS: ${totalMatriculados}\n`;
            conteudo += `Presen√ßa (MATRI): ${totais.totalPresenca}\n`;
            conteudo += `VISITANTES: ${totais.totalVisitantes}\n`;
            conteudo += `REVISTAS: ${totais.totalRevista}\n`;
            conteudo += `B√çBLIA: ${totais.totalBiblia}\n`;
            conteudo += `OFERTA: ${totais.totalOferta}\n`;
            conteudo += `--------------------------------------------------\n\n`;

            conteudo += `DETALHES DOS ALUNOS:\n`;
            conteudo += `N¬∫;NOME;MATRI (Presen√ßa);VIST;REVIST;B√çBLIA;OFET;PONTOS\n`;
            
            document.querySelectorAll('#corpo-tabela-alunos .linha-aluno').forEach((linha, index) => {
                const aluno = dadosAlunosSessao[index];
                // Certifica-se de remover qualquer ; ou \n do nome para n√£o quebrar o CSV
                const nomeSeguro = aluno.nome.replace(/[,;\n]/g, ' ').trim();
                conteudo += `${(index + 1).toString().padStart(2, '0')};${nomeSeguro};${aluno.presente ? 'SIM' : 'N√ÉO'};${aluno.visitantes};${aluno.revista ? 'SIM' : 'N√ÉO'};${aluno.biblia ? 'SIM' : 'N√ÉO'};${aluno.oferta ? 'SIM' : 'N√ÉO'};${aluno.pontuacao}\n`;
            });

            // Gerar download do arquivo CSV
            const nomeArquivo = `Relatorio_EBS_${turma}_${dataFormatada.replace(/\//g, '_')}_AULA_${getRelatoriosTrimestre().length}.csv`;
            
            const linkDownload = document.createElement('a');
            // Mime type alterado para text/csv
            linkDownload.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(conteudo);
            linkDownload.download = nomeArquivo;
            
            document.body.appendChild(linkDownload);
            linkDownload.click();
            document.body.removeChild(linkDownload);
            
            alert(`Relat√≥rio salvo com sucesso no navegador e baixado como "${nomeArquivo}"!`);
            calcularTotais(); // Recarrega o ranking trimestral atualizado
        }

        // --- NOVO: FUN√á√ÉO PARA MOVER ALUNO NA LISTA (REORDENA√á√ÉO) ---
        function moverAluno(botao, direcao) {
            const linhaAtual = botao.closest('tr');
            const corpoTabela = document.getElementById('corpo-tabela-alunos');
            const linhas = Array.from(corpoTabela.children);
            const indiceAtual = linhas.indexOf(linhaAtual);
            const indiceNovo = indiceAtual + direcao;

            // Verifica se o novo √≠ndice √© v√°lido
            if (indiceNovo >= 0 && indiceNovo < linhas.length) {
                const nomeAluno = linhaAtual.querySelector('.nome-aluno').value;
                
                // 1. Mover no DOM (Tabela HTML)
                if (direcao === -1) { // Mover para cima
                    corpoTabela.insertBefore(linhaAtual, linhas[indiceNovo]);
                } else if (direcao === 1) { // Mover para baixo
                    // Se estiver movendo para baixo, insere *depois* do alvo (indiceNovo)
                    // Para inserir depois de linhas[indiceNovo], usamos linhas[indiceNovo + 1] como refer√™ncia.
                    const proximaLinha = linhas[indiceNovo + 1];
                    corpoTabela.insertBefore(linhaAtual, proximaLinha);
                }

                // 2. Mover no Local Storage (Lista de Matriculados)
                let alunos = getAlunosMatriculados();
                
                // Remove o aluno da posi√ß√£o atual
                const alunoMovido = alunos.splice(indiceAtual, 1)[0]; 
                // Insere o aluno na nova posi√ß√£o
                alunos.splice(indiceNovo, 0, alunoMovido); 
                
                setAlunosMatriculados(alunos);
                
                // 3. Recalcular e re-numerar
                calcularTotais(); 
                reordenarNumeracao();
            }
        }

        // --- NOVO: FUN√á√ÉO AUXILIAR PARA CORRIGIR A NUMERA√á√ÉO ---
        function reordenarNumeracao() {
            const corpoTabela = document.getElementById('corpo-tabela-alunos');
            const linhasAlunos = corpoTabela.querySelectorAll('.linha-aluno');
            
            linhasAlunos.forEach((linha, index) => {
                linha.querySelector('.num-aluno').textContent = (index + 1).toString().padStart(2, '0');
            });
        }

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
             carregarAlunosIniciais();
             reordenarNumeracao(); // Garante que a numera√ß√£o est√° correta no carregamento
        });
    </script>
</body>
</html>
